<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HomeSync Radio</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .radio-container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 100%;
    }
    
    h1 {
      margin: 0 0 10px 0;
      font-size: 2.5em;
      font-weight: 300;
    }
    
    .subtitle {
      font-size: 1.1em;
      opacity: 0.8;
      margin-bottom: 30px;
    }
    
    .status {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
      font-size: 0.9em;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      background: #ff4444;
      animation: pulse 2s infinite;
    }
    
    .status-indicator.playing {
      background: #44ff44;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .audio-container {
      margin: 20px 0;
      position: relative;
    }
    
    audio {
      width: 100%;
      outline: none;
      border-radius: 10px;
    }
    
    .listeners {
      font-size: 0.8em;
      opacity: 0.7;
      margin-top: 15px;
    }
    
    .error-message {
      background: rgba(255, 68, 68, 0.2);
      border: 1px solid rgba(255, 68, 68, 0.5);
      border-radius: 10px;
      padding: 10px;
      margin: 10px 0;
      display: none;
    }
    
    .admin-link {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 10px;
      margin-top: 20px;
      font-size: 0.8em;
    }
    
    .admin-link a {
      color: #4ade80;
      text-decoration: none;
    }
    
    .admin-link a:hover {
      text-decoration: underline;
    }
    
    .play-button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50px;
      color: white;
      padding: 12px 30px;
      font-size: 16px;
      cursor: pointer;
      margin: 15px auto;
      display: block;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    
    .play-button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }
    
    .play-button.hidden {
      display: none;
    }
    
    .sync-option {
      margin-top: 20px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      font-size: 0.9em;
    }
    
    .sync-badge {
      display: inline-block;
      background: rgba(255, 136, 0, 0.8);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7em;
      margin-left: 5px;
      vertical-align: middle;
    }
    
    .sync-link {
      display: inline-block;
      margin-top: 8px;
      color: #4ade80;
      text-decoration: none;
    }
    
    .sync-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="radio-container">
    <h1>üé∂ HomeSync Radio</h1>
    <p class="subtitle">Live streaming radio - everyone hears the same thing!</p>
    
    <div class="status">
      <span class="status-indicator" id="statusDot"></span>
      <span id="statusText">Connecting...</span>
    </div>
    
    <div class="error-message" id="errorMessage"></div>
    
    <div class="audio-container">
      <audio id="radioStream" preload="none"></audio>
      <button id="playButton" class="play-button">‚ñ∂Ô∏è Click to Play</button>
    </div>
    
    <div class="listeners">
      <span id="listenerInfo">üéß Tuned in to the live stream</span>
    </div>
    
    <div class="sync-option">
      <strong>Want perfect synchronization?</strong>
      <span class="sync-badge">NEW!</span>
      <p>Try our new synchronized player for perfect timing across all devices!</p>
      <a href="/sync-player.html" class="sync-link">‚û°Ô∏è Switch to Synchronized Player</a>
    </div>
    
    <div class="admin-link">
      <a href="/admin">Admin Panel</a> | 
      <a href="/choose-player.html">Choose Player</a>
    </div>
  </div>

  <script>
    const audio = document.getElementById('radioStream');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const errorMessage = document.getElementById('errorMessage');
    const playButton = document.getElementById('playButton');
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let lastConnectionAttempt = 0;
    const connectionThrottleMs = 2000; // Prevent rapid reconnection attempts
    
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 5000);
    }
    
    function updateStatus(text, isPlaying = false) {
      statusText.textContent = text;
      statusDot.className = `status-indicator ${isPlaying ? 'playing' : ''}`;
    }
    
    function connectToRadio(force = false) {
      // Throttle connection attempts
      const now = Date.now();
      if (!force && now - lastConnectionAttempt < connectionThrottleMs) {
        console.log('Connection attempt throttled, too many requests');
        return;
      }
      
      lastConnectionAttempt = now;
      updateStatus('Connecting to radio...');
      
      // Abort any existing connections
      if (audio.src) {
        audio.pause();
        audio.removeAttribute('src');
        audio.load();
      }
      
      // Add timestamp to prevent caching
      const streamUrl = `/stream?t=${Date.now()}`;
      
      // Check server status first
      fetch('/api/radio-status')
        .then(response => response.json())
        .then(status => {
          if (!status.isPlaying) {
            updateStatus('‚è∏Ô∏è Radio is paused on server', false);
            showError('The radio is currently paused on the server. Please wait for it to resume.');
            setTimeout(() => getRadioStatus(), 3000);
            // Show play button even when server is paused (clicking will check again)
            playButton.style.display = 'block';
            return;
          }
          
          // Server is playing, attempt to connect
          audio.src = streamUrl;
          
          // Add specific event handlers inside this promise chain
          const loadingTimeout = setTimeout(() => {
            if (audio.readyState < 3) { // HAVE_FUTURE_DATA
              showError('Stream is taking too long to load. Retrying...');
              audio.load(); // Force reload
            }
          }, 5000);
          
          const playPromise = audio.play();
          if (playPromise !== undefined) {
            playPromise.catch(e => {
              console.error('Playback failed:', e);
              clearTimeout(loadingTimeout);
              if (e.name === 'NotAllowedError') {
                updateStatus('Click Play button to start listening');
                // Make play button visible when autoplay is blocked
                playButton.style.display = 'block';
              } else {
                updateStatus('Connection failed');
                setTimeout(() => connectToRadio(true), 3000);
              }
            });
          }
        })
        .catch(error => {
          console.error('Failed to check radio status:', error);
          updateStatus('Server connection error');
          showError('Cannot connect to the radio server. Please try again later.');
        });
    }
    
    // Clear all previous event listeners
    function clearAudioEvents() {
      const eventsToClear = ['loadstart', 'loadedmetadata', 'canplay', 'playing', 'error', 'ended', 'stalled', 'suspend', 'waiting'];
      eventsToClear.forEach(event => {
        audio.removeEventListener(event, () => {});
      });
    }
    
    // Setup audio event listeners
    function setupAudioEvents() {
      clearAudioEvents();
      
      audio.addEventListener('loadstart', () => {
        updateStatus('Loading stream...');
        console.log('Stream loading started');
      });
      
      audio.addEventListener('loadedmetadata', () => {
        console.log('Stream metadata loaded');
      });
      
      audio.addEventListener('canplay', () => {
        updateStatus('Stream ready, starting playback...');
        console.log('Stream can play');
      });
      
      audio.addEventListener('playing', () => {
        updateStatus('üéµ Live Radio Playing', true);
        reconnectAttempts = 0;
        console.log('Stream is playing');
        // Hide play button when audio is playing
        playButton.style.display = 'none';
      });
      
      audio.addEventListener('stalled', () => {
        console.log('Stream stalled');
        if (reconnectAttempts < maxReconnectAttempts) {
          showError('Stream stalled. Attempting to recover...');
        }
      });
      
      audio.addEventListener('waiting', () => {
        console.log('Stream waiting for data');
      });
      
      audio.addEventListener('error', (e) => {
        const errorCode = audio.error ? audio.error.code : 'unknown';
        console.error(`Audio error: ${errorCode}`, e);
        updateStatus('Connection lost');
        
        if (reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          showError(`Connection lost. Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`);
          setTimeout(() => connectToRadio(true), 2000 * reconnectAttempts);
        } else {
          showError('Unable to connect to radio after multiple attempts. The server may be down or unreachable.');
        }
      });
      
      audio.addEventListener('ended', () => {
        console.log('Stream ended');
        // Audio ended, reconnect (this handles when the stream loops)
        setTimeout(() => connectToRadio(true), 1000);
      });
    }
    
    // Remove all user controls from audio element
    audio.controls = false;
    audio.addEventListener('contextmenu', (e) => e.preventDefault());
    
    // Set other audio properties
    audio.preload = 'auto';
    audio.crossOrigin = 'anonymous';
    
    // Get radio status for real-time updates    
    async function getRadioStatus() {
      try {
        const response = await fetch('/api/radio-status');
        const status = await response.json();
        
        if (status.currentTrack) {
          // Update track name
          document.querySelector('.subtitle').textContent = 
            `üéµ Now Playing: ${status.currentTrack.name}`;
          
          // Update status indicator based on server state AND local playback state
          if (status.isPlaying) {
            if (!audio.paused && audio.readyState > 2) {
              // Only show playing if both server is playing AND local audio is actually playing
              updateStatus('üéµ Live Radio Playing', true);
            } else {
              // Server is playing but local audio is not playing yet
              updateStatus('Click Play button to start listening', false);
              playButton.style.display = 'block';
            }
            
            // If radio is playing on server but audio is paused locally, don't reconnect automatically
            // This allows user to control when to start playing
            if (audio.paused && (!audio.src || audio.error)) {
              console.log('Server is playing but local audio is paused, waiting for user interaction');
              // Don't auto-reconnect here
            }
          } else {
            updateStatus('‚è∏Ô∏è Radio Paused', false);
            
            // If radio is paused on server but audio is playing locally, pause it
            if (!audio.paused) {
              console.log('Server is paused, stopping local audio');
              audio.pause();
            }
          }
          
          // Update listener info with track index
          document.getElementById('listenerInfo').textContent =
            `üéß Track ${status.currentTrackIndex + 1}/${status.totalTracks} - Tuned in to the live stream`;
        } else {
          document.querySelector('.subtitle').textContent =
            'Live streaming radio - No track loaded';
          updateStatus('No track available', false);
        }
      } catch (error) {
        console.log('Could not fetch radio status:', error);
        // Only show error if we have multiple failed attempts
        if (reconnectAttempts > 1) {
          showError('Lost connection to server. Will keep trying to reconnect.');
        }
      }
    }

    // Setup audio event handlers
    setupAudioEvents();

    // Auto-connect when page loads
    document.addEventListener('DOMContentLoaded', () => {
      // Connect immediately without delay
      connectToRadio();
      
      // First status check
      getRadioStatus();
      
      // Update status regularly
      setInterval(getRadioStatus, 3000);
      
      // Add click handler for play button
      playButton.addEventListener('click', () => {
        playButton.textContent = 'üîÑ Connecting...';
        connectToRadio(true);
      });
    });
    
    // Handle page visibility changes (reconnect when tab becomes active)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        getRadioStatus();
        if (audio.paused) {
          setTimeout(() => connectToRadio(), 500);
        }
      }
    });
  </script>
</body>
</html> 